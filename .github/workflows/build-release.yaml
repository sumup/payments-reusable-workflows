name: Build Application,Deploy to theta
on:
  workflow_call:
    inputs:
      image_repository:
        description: The image repository for the built images, defaults to value of `Image.repository` from `values.yaml`
        required: false
        default: nexus.sam-app.ro:5000
        type: string
      image_name:
        description: Built image name, defaults to value of Image.name from values.yaml
        required: false
        default: ''
        type: string
      image_tag:
        description: Built image tag, defaults to value of `Image.tag` from `values.yaml`
        required: false
        default: ''
        type: string
      target:
        description: The build target if image needs to be build to sertain layer ex.builder
        required: false
        default: 'builder'
        type: string
      test_commands:
        description: Test commands to run in development container for executing tests, one per line
        required: false
        default: ''
        type: string
      results_path:
        description: The directory ( in the container ) where results will be stored
        required: false
        default: /tmp
        type: string
      chart_repository:
        required: true
        type: string
      stage_config_path:
        description: Path deploy repo Stage configurations 
        required: true
        type: string
      prod_config_path:
        description: Path deploy repo Prod configurations 
        required: true
        type: string
      slack_channel:
        description: The slack channel where you want your messages being sent
        required: false
        default: ''
        type: string

jobs:
  application_build:
    runs-on: [ "self-hosted", "payments-tribe" ]
    outputs:
      image_tag: ${{ steps.build-final-container.outputs.image_tag }}
      imageSha: ${{ steps.build-final-container.outputs.imageSha }}
    steps:
      - name: "‚òÅÔ∏è Check out project code"
        uses: actions/checkout@a12a3943b4bdde767164f792f33f40b04645d846
        with:
          fetch-depth: 0

      - name: "‚òÅÔ∏è Check out payments composite actions"
        uses: actions/checkout@a12a3943b4bdde767164f792f33f40b04645d846
        with:
          repository: 'sumup/payments-composite-actions'
          token: ${{ secrets.GH_ACTIONS_CI_PAT }}
          path: .github/payments-composite-actions
          ref: 'main'

      - name: "üì¶ Build development container"
        id: build-development-container
        if: inputs.test_commands != ''
        uses: ./.github/payments-composite-actions/docker/build
        with:
          image_repository: ${{ inputs.image_repository }}
          image_name: ${{ inputs.image_name }}
          image_tag: ${{ inputs.image_tag }}
          target: ${{ inputs.target }}
          ssh_agent_key: ${{ secrets.ACTIONS_SSH_AGENT_KEY }}

      - name: "üß™ Run tests on development container"
        if: inputs.test_commands != ''
        uses: ./.github/payments-composite-actions/docker/run-builder-tests
        with:
          image_full_name: ${{ steps.build-development-container.outputs.image_full_name }}
          results_path: ${{ inputs.results_path }}
          test_commands: ${{ inputs.test_commands }}

      - name: "üì¶ Build final container"
        id: build-final-container
        uses: ./.github/payments-composite-actions/docker/build
        with:
          image_repository: ${{ inputs.image_repository }}
          image_name: ${{ inputs.image_name }}
          image_tag: ${{ inputs.image_tag }}
          ssh_agent_key: ${{ secrets.ACTIONS_SSH_AGENT_KEY }}

      - name: "üîç Scan container"
        id: call-scan-container
        uses: ./.github/payments-composite-actions/docker/trivy-scan
        with:
          gh_token: ${{ secrets.GH_ACTIONS_CI_PAT }}
          image_full_name: ${{ steps.build-final-container.outputs.image_full_name }}

      - name: "üóÉÔ∏è Publish container"
        id: call-publish-container
        uses: ./.github/payments-composite-actions/docker/push
        with:
          image_full_name: ${{ steps.build-final-container.outputs.image_full_name }}
          image_repository: ${{ inputs.image_repository }}
          iam_login: true

      - name: "‚úâÔ∏è Send slack message if failed"
        if: ${{ failure() }}
        uses: ./.github/payments-composite-actions/notifications/slack-send
        with:
          slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          slack_channel: ${{ inputs.slack_channel }}
          color: "danger"
          message: "The Github Actions build has failed for image with "
####
####   CHART TEST AND BUILD
####
  chart_changes:
    runs-on: ["self-hosted", "payments-tribe"]
    outputs:
      changeset: ${{ steps.get_changes.outputs.changeset }}
    steps:
      - name: "‚òÅÔ∏è Check out project code"
        uses: actions/checkout@a12a3943b4bdde767164f792f33f40b04645d846
        with:
          fetch-depth: 2

      - name: "üìù Get changes from last commit"
        id: get_changes
        run: |
          changeset=false
          echo "::debug:: last commit raw # $(git diff-tree --no-commit-id --name-only -r ${{ github.sha }})"
          for change in $(git diff-tree --no-commit-id --name-only -r ${{ github.sha }}); do
            parent_dir=$(dirname "$change")
            echo "::debug::=== change at $parent_dir"
            if echo $parent_dir | grep -q '.deployment/chart'; then
               changeset=true
               echo "::debug:: localted chart change in $change, triggering rebuild"
               break
            fi
          done
          echo "::set-output name=changeset::${changeset}"

  chart_build:
    runs-on: ["self-hosted", "payments-tribe"]
    outputs:
      chart_version: ${{ steps.package-chart.outputs.chart_version }}
    needs: [ 'chart_changes' ]
    if: ${{ needs.changes.outputs.changeset == 'true' }}
    steps:
      - name: "‚òÅÔ∏è Check out project code"
        uses: actions/checkout@a12a3943b4bdde767164f792f33f40b04645d846
        with:
          fetch-depth: 0

      - name: "‚òÅÔ∏è Check out payments composite actions"
        uses: actions/checkout@a12a3943b4bdde767164f792f33f40b04645d846
        with:
          repository: 'sumup/payments-composite-actions'
          token: ${{ secrets.GH_ACTIONS_CI_PAT }}
          path: .github/payments-composite-actions
          ref: 'main'

      - name: "üß™ Test helm chart"
        uses: ./.github/payments-composite-actions/helm/ct-test

      - name: "üì¶ Build helm package"
        id: package-chart
        uses: ./.github/payments-composite-actions/helm/package
        with:
          project_dir: '.'
          chart_repository: ${{ inputs.chart_repository }}

      - name: "‚úâÔ∏è Send slack message if failed"
        if: ${{ failure() }}
        uses: ./.github/payments-composite-actions/notifications/slack-send
        with:
          slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          slack_channel: ${{ inputs.slack_channel }}
          color: "danger"
          message: "Chart Build failed with "
####
####   Deploy infra update for stage
####
  deploy_stage:
    runs-on: ["self-hosted", "payments-tribe"]
    needs: [ 'application_build', 'chart_build' ]
    if: always() && needs.application_build.result != 'failure' && needs.chart_build.result != 'failure'
    outputs:
      pr_number: ${{ steps.deploy_infra_update.outputs.pr_number }}
    steps:
      - name: "‚òÅÔ∏è Check out project code"
        uses: actions/checkout@a12a3943b4bdde767164f792f33f40b04645d846
        with:
          fetch-depth: 2

      - name: "‚òÅÔ∏è Check out payments composite actions"
        uses: actions/checkout@a12a3943b4bdde767164f792f33f40b04645d846
        with:
          repository: 'sumup/payments-composite-actions'
          token: ${{ secrets.GH_ACTIONS_CI_PAT }}
          path: .github/payments-composite-actions
          ref: 'main'

      - name: "üöÄ Push Changes to Deploy infra repo"
        id: deploy_infra_update
        uses: ./.github/payments-composite-actions/deploy-infra-update
        with:
          deployment_config_path: ${{ inputs.stage_config_path }}
          deployment_environment: "Stage"
          github_token: ${{ secrets.GH_ACTIONS_CI_PAT }}
          chart_version: ${{ needs.chart_build.outputs.chart_version }}
          image_tag: ${{ needs.application_build.outputs.image_tag }}

      - name: "üìù Stage Deploy info"
        id: stage_deploy_info
        run: |
          echo "#### To Deploy to Staging please merge  [this PR](https://github.com/sumup/deploy-infra/pull/${{ steps.deploy_infra_update.outputs.pr_number }})" >> $GITHUB_STEP_SUMMARY
      
      - name: "‚úâÔ∏è Send slack message if failed"
        if: ${{ failure() }}
        uses: ./.github/payments-composite-actions/notifications/slack-send
        with:
          slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          slack_channel: ${{ inputs.slack_channel }}
          color: "danger"
          message: "Failed to update deploy infra repository"
####
####   Deploy infra update for prod
####
  deploy_prod:
    runs-on: ["self-hosted", "payments-tribe"]
    needs: [ 'application_build', 'chart_build', 'deploy_stage' ]
    if: always() && needs.application_build.result != 'failure' && needs.chart_build.result != 'failure' && needs.deploy_stage.result != 'failure'
    outputs:
      pr_number: ${{ steps.deploy_infra_update.outputs.pr_number }}
    steps:
      - name: "‚òÅÔ∏è Check out project code"
        uses: actions/checkout@a12a3943b4bdde767164f792f33f40b04645d846
        with:
          fetch-depth: 2

      - name: "‚òÅÔ∏è Check out payments composite actions"
        uses: actions/checkout@a12a3943b4bdde767164f792f33f40b04645d846
        with:
          repository: 'sumup/payments-composite-actions'
          token: ${{ secrets.GH_ACTIONS_CI_PAT }}
          path: .github/payments-composite-actions
          ref: 'main'

      - name: "üöÄ Push Changes to Deploy infra repo"
        id: deploy_infra_update
        uses: ./.github/payments-composite-actions/deploy-infra-update
        with:
          deployment_config_path: ${{ inputs.prod_config_path }}
          deployment_environment: "Prod"
          github_token: ${{ secrets.GH_ACTIONS_CI_PAT }}
          chart_version: ${{ needs.chart_build.outputs.chart_version }}
          image_tag: ${{ needs.application_build.outputs.image_tag }}

      - name: "üìù Stage Deploy info"
        id: stage_deploy_info
        run: |
          echo "#### To Deploy to Production please merge  [this PR](https://github.com/sumup/deploy-infra/pull/${{ steps.deploy_infra_update.outputs.pr_number }})" >> $GITHUB_STEP_SUMMARY
      
      - name: "‚úâÔ∏è Send slack message if failed"
        if: ${{ failure() }}
        uses: ./.github/payments-composite-actions/notifications/slack-send
        with:
          slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          slack_channel: ${{ inputs.slack_channel }}
          color: "danger"
          message: "Failed to update deploy infra repository"
####
####   Send Slack notification
####
  notification:
    runs-on: ["self-hosted", "payments-tribe"]
    needs: [ 'deploy_stage', 'deploy_prod' ]
    if: always() && needs.deploy_repo.result == 'success'
    steps:
      - name: "‚òÅÔ∏è Check out payments composite actions"
        uses: actions/checkout@a12a3943b4bdde767164f792f33f40b04645d846
        with:
          repository: 'sumup/payments-composite-actions'
          token: ${{ secrets.GH_ACTIONS_CI_PAT }}
          path: .github/payments-composite-actions
          ref: 'main'

      - name: "‚úâÔ∏è Send slack message if successful"
        if: ${{ success() }}
        uses: ./.github/payments-composite-actions/notifications/slack-send
        with:
          slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          color: "good"
          message: "Build completed. Deploy Infra is updated, [Stage PR](https://github.com/sumup/deploy-infra/pull/${{ needs.deploy_stage.outputs.pr_number }}) , [Production PR](https://github.com/sumup/deploy-infra/pull/${{ needs.deploy_prod.outputs.pr_number }})"

